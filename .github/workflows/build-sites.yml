name: Build and Deploy Niche Sites

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run daily at 6 AM UTC to update product data
    - cron: '0 6 * * *'

permissions:
  contents: write

jobs:
  build-and-publish-sites:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate and publish sites to individual repositories
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          AMAZON_AFFILIATE_ID: ${{ secrets.AMAZON_AFFILIATE_ID }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ðŸš€ Generating niche sites and publishing to individual repositories..."
          node site-generator.js
          echo "âœ… All sites generated and published successfully!"
      
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each niche site has been deployed to its own repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "sites/_niches_data.json" ]; then
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('sites/_niches_data.json', 'utf-8'));
              data.forEach(({ niche, slug, url }) => {
                console.log(\`- **\${niche}**: [\${url}](\${url})\`);
              });
            " >> $GITHUB_STEP_SUMMARY
          fi

