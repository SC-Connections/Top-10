name: Build and Deploy Niche Sites

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 6 AM UTC to update product data
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  build-and-publish-sites:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-xcb1 libxtst6 libxcomposite1 libxi6 libxrender1 libxrandr2
      
      - name: Set timestamp
        run: echo "UPDATE_TIMESTAMP=$(date '+%B %d, %Y')" >> $GITHUB_ENV
      
      - name: Generate niche sites
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          AMAZON_AFFILIATE_ID: ${{ secrets.AMAZON_AFFILIATE_ID }}
          UPDATE_TIMESTAMP: ${{ env.UPDATE_TIMESTAMP }}
        run: |
          echo "ðŸš€ Generating niche sites..."
          node site-generator.js
          echo "âœ… All sites generated successfully!"
      
      - name: Generate root index.html
        run: npm run generate-root-index
      
      - name: Commit and push generated sites
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto-generate niche sites" || echo "No changes to commit"
          git push
      
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Niche sites have been generated and committed to the main branch:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_niches_data.json" ]; then
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('_niches_data.json', 'utf-8'));
              data.forEach(({ niche, slug, url }) => {
                console.log(\`- **\${niche}**: [\${url}](\${url})\`);
              });
            " >> $GITHUB_STEP_SUMMARY
          fi

