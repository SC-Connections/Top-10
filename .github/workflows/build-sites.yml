name: Build and Deploy Niche Sites

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 6 AM UTC to update product data
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  build-and-publish-sites:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Install Puppeteer dependencies
        run: |
          echo "üì¶ Installing Puppeteer system dependencies..."
          sudo apt-get update -qq

          # Install common dependencies (most runners will have these packages)
          sudo apt-get install -y \
            libx11-xcb1 \
            libxtst6 \
            libxcomposite1 \
            libxi6 \
            libxrender1 \
            libxrandr2 \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libxss1 \
            libxdamage1 \
            libgbm1 || echo "‚ö†Ô∏è  Some Puppeteer dependencies failed to install (non-fatal)"

          # Try sound package variants with explicit fallback handling to support different Ubuntu runner versions
          if sudo apt-get install -y libasound2; then
            echo "‚úÖ Installed libasound2"
          elif sudo apt-get install -y libasound2t64; then
            echo "‚úÖ Installed libasound2t64"
          else
            echo "‚ö†Ô∏è  Neither libasound2 nor libasound2t64 could be installed on this runner. Puppeteer may still work depending on the environment."
          fi
      
      - name: Set timestamp
        run: echo "UPDATE_TIMESTAMP=$(date '+%B %d, %Y')" >> $GITHUB_ENV
      
      - name: Generate niche sites
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          AMAZON_AFFILIATE_ID: ${{ secrets.AMAZON_AFFILIATE_ID }}
          UPDATE_TIMESTAMP: ${{ env.UPDATE_TIMESTAMP }}
          SKIP_PUPPETEER: 'false'  # Try to use Puppeteer, but will fallback if it fails
        run: |
          echo "üöÄ Generating niche sites..."
          node site-generator.js
          echo "‚úÖ Site generation complete!"
      
      - name: Verify niche folders were generated
        run: |
          echo "üîç Verifying generated niche folders..."

          if [ ! -f "_niches_data.json" ]; then
            echo "‚ùå ERROR: _niches_data.json was not generated!"
            echo "[]" > _niches_data.json
            echo "‚ÑπÔ∏è  Created empty _niches_data.json to avoid hard failure."
          fi

          # Check each niche folder
          missing_count=0
          total_niches=0
          while IFS= read -r slug; do
            if [ -n "$slug" ]; then
              total_niches=$((total_niches + 1))
              if [ ! -d "$slug" ] || [ ! -f "$slug/index.html" ]; then
                echo "‚ùå Missing or incomplete: $slug/"
                missing_count=$((missing_count + 1))
              else
                echo "‚úÖ Verified: $slug/"
              fi
            fi
          done < <(node -e "const data = require('./_niches_data.json'); if (Array.isArray(data)) data.forEach(n => console.log(n.slug));")

          if [ $missing_count -gt 0 ]; then
            echo "‚ö†Ô∏è WARNING: $missing_count of $total_niches niche folder(s) failed to generate."
            echo "‚ö†Ô∏è This is non-fatal: continuing workflow so valid sites can still be published. Check logs above for failed niches."
          else
            echo "‚úÖ All niche folders generated successfully!"
          fi
      
      - name: Generate root index.html
        run: npm run generate-root-index
      
      - name: Commit and push generated sites
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto-generate niche sites" || echo "No changes to commit"
          git push
      
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Niche sites have been generated and committed to the main branch:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_niches_data.json" ]; then
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('_niches_data.json', 'utf-8'));
              data.forEach(({ niche, slug, url }) => {
                console.log(\`- **\${niche}**: [\${url}](\${url})\`);
              });
            " >> $GITHUB_STEP_SUMMARY
          fi

