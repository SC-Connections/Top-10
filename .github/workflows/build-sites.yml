name: Build and Deploy Niche Sites

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 6 AM UTC to update product data
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  build-and-publish-sites:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
   - name: Install Puppeteer dependencies
  run: |
    sudo apt-get update

    # Determine correct libasound package name for this runner
    if apt-cache show libasound2 >/dev/null 2>&1; then
      SOUND_PKG=libasound2
    elif apt-cache show libasound2t64 >/dev/null 2>&1; then
      SOUND_PKG=libasound2t64
    else
      echo "No ALSA sound library found in apt repositories on this runner. Continuing without ALSA package."
      SOUND_PKG=""
    fi

    echo "Installing Puppeteer dependencies; using ${SOUND_PKG:-<none>} for ALSA"

    # Build base package list
    PKGS=(
      libnss3
      libatk-bridge2.0-0
      libdrm2
      libxkbcommon0
      libgbm1
      libxrandr2
      libxcomposite1
      libxdamage1
      libxfixes3
      libcups2
    )

    # Add SOUND_PKG if set
    if [ -n "$SOUND_PKG" ]; then
      PKGS+=("$SOUND_PKG")
    fi

    sudo apt-get install -y "${PKGS[@]}"
      
      - name: Set timestamp
        run: echo "UPDATE_TIMESTAMP=$(date '+%B %d, %Y')" >> $GITHUB_ENV
      
      - name: Auto-fix validation errors (pre-generation)
        run: |
          echo "ðŸ”§ Running auto-fix validation..."
          node scripts/auto-fix-validation.js || echo "No existing data to fix"
      
      - name: Generate niche sites
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          AMAZON_AFFILIATE_ID: ${{ secrets.AMAZON_AFFILIATE_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          UPDATE_TIMESTAMP: ${{ env.UPDATE_TIMESTAMP }}
        run: |
          echo "ðŸš€ Generating niche sites..."
          node site-generator.js
          echo "âœ… All sites generated successfully!"
      
      - name: Auto-fix validation errors (post-generation)
        run: |
          echo "ðŸ”§ Running post-generation auto-fix..."
          node scripts/auto-fix-validation.js
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Run validation checks
        run: |
          echo "ðŸ” Running validation checks..."
          python3 scripts/validate.py
          echo "âœ… Validation passed!"
      
      - name: Generate root index.html
        run: npm run generate-root-index
      
      - name: Commit and push generated sites
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto-generate niche sites" || echo "No changes to commit"
          git push
      
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Niche sites have been generated and committed to the main branch:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_niches_data.json" ]; then
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('_niches_data.json', 'utf-8'));
              data.forEach(({ niche, slug, url }) => {
                console.log(\`- **\${niche}**: [\${url}](\${url})\`);
              });
            " >> $GITHUB_STEP_SUMMARY
          fi

