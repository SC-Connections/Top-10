name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build and Deploy Niche Sites"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate root index.html
        run: npm run generate-root-index
      
      - name: Validate niche folders exist
        run: |
          echo "üîç Validating niche folders..."
          
          # Check if _niches_data.json exists
          if [ ! -f "_niches_data.json" ]; then
            echo "‚ùå ERROR: _niches_data.json not found!"
            echo "‚ùå Niche sites have not been generated yet."
            echo "‚ùå Run the 'Build and Deploy Niche Sites' workflow first."
            exit 1
          fi
          
          # Extract niche slugs and verify folders exist
          missing_folders=0
          while IFS= read -r slug; do
            if [ -n "$slug" ]; then
              if [ ! -d "$slug" ]; then
                echo "‚ùå Missing niche folder: $slug/"
                missing_folders=$((missing_folders + 1))
              else
                if [ ! -f "$slug/index.html" ]; then
                  echo "‚ùå Missing index.html in: $slug/"
                  missing_folders=$((missing_folders + 1))
                else
                  echo "‚úÖ Found: $slug/index.html"
                fi
              fi
            fi
          done < <(node -e "const data = require('./_niches_data.json'); data.forEach(n => console.log(n.slug));")
          
          if [ $missing_folders -gt 0 ]; then
            echo ""
            echo "‚ùå ERROR: $missing_folders niche folder(s) are missing or incomplete!"
            echo "‚ùå Niche sites must be generated before deployment."
            echo "‚ùå This usually means the 'Build and Deploy Niche Sites' workflow failed or hasn't run yet."
            echo ""
            echo "To fix this:"
            echo "1. Check the 'Build and Deploy Niche Sites' workflow logs"
            echo "2. Ensure RAPIDAPI_KEY secret is set"
            echo "3. Manually trigger the 'Build and Deploy Niche Sites' workflow"
            exit 1
          fi
          
          echo "‚úÖ All niche folders validated successfully!"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Move niche folders to Pages root
        run: |
          # If sites/ directory exists, move all subdirectories to root
          if [ -d "sites" ]; then
            echo "üì¶ Moving niche folders from sites/ to root..."
            shopt -s dotglob
            for dir in sites/*; do
              if [ -d "$dir" ]; then
                basename=$(basename "$dir")
                echo "  Moving $dir to ./$basename/"
                mv "$dir" .
              fi
            done
            # Remove empty sites directory
            rmdir sites 2>/dev/null || true
            echo "‚úÖ Niche folders moved successfully!"
          else
            echo "‚ÑπÔ∏è  No sites/ directory found,"
            echo "   niche folders already at root level"
          fi
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
